name: Update Winget Package

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  winget:
    runs-on: windows-latest

    steps:
      - name: Verify public GitHub release
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $repo = "${{ github.repository }}"

          $releases = gh api repos/$repo/releases | ConvertFrom-Json
          $release = $releases | Select-Object -First 1

          if ($release.draft -or $release.prerelease) {
            Write-Error "Latest release is not public. Aborting."
            exit 1
          }

          echo "VERSION=$($release.tag_name.TrimStart('v'))" >> $env:GITHUB_ENV

      - name: Install wingetcreate
        run: |
          iwr https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Fetch release notes
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $repo = "${{ github.repository }}"
          $tag = "v$env:VERSION"

          $release = gh api repos/$repo/releases/tags/$tag | ConvertFrom-Json
          $notes = if ($release.body) { $release.body } else { "Release $tag" }

          echo "NOTES<<EOF" >> $env:GITHUB_ENV
          echo $notes >> $env:GITHUB_ENV
          echo "EOF" >> $env:GITHUB_ENV

      - name: Close old Winget PRs
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          gh pr list `
            --repo microsoft/winget-pkgs `
            --search "NASS.DHLabel" `
            --state open `
            --json number,title |
          ConvertFrom-Json |
          Where-Object { $_.title -notmatch $env:VERSION } |
          ForEach-Object {
            gh pr close $_.number --repo microsoft/winget-pkgs --comment "Superseded by newer release."
          }

      - name: Winget validation (dry run)
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          wingetcreate.exe update `
            NASS.DHLabel `
            --version $env:VERSION `
            --installer-url https://github.com/${{ github.repository }}/releases/download/v$env:VERSION/DHLabel-Setup-$env:VERSION.exe `
            --dry-run

      - name: Submit Winget update
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          wingetcreate.exe update `
            NASS.DHLabel `
            --version $env:VERSION `
            --installer-url https://github.com/${{ github.repository }}/releases/download/v$env:VERSION/DHLabel-Setup-$env:VERSION.exe `
            --submit `
            --notes "$env:NOTES"
